<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PretoucherState.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenHFT/Chronicle-Queue</a> &gt; <a href="index.source.html" class="el_package">net.openhft.chronicle.queue.impl.single</a> &gt; <span class="el_source">PretoucherState.java</span></div><h1>PretoucherState.java</h1><pre class="source lang-java linenums">package net.openhft.chronicle.queue.impl.single;

import net.openhft.chronicle.bytes.MappedBytes;
import net.openhft.chronicle.core.Jvm;
import net.openhft.chronicle.core.OS;
import org.jetbrains.annotations.NotNull;

import java.io.File;
import java.util.function.LongSupplier;

class PretoucherState {
<span class="fc" id="L12">    private static final int HEAD_ROOM = Integer.getInteger(&quot;PretoucherState.headRoom&quot;, 1 &lt;&lt; 20);</span>
    public static final int FACTOR = 4;
    @NotNull
    private final LongSupplier posSupplier;
    private int minHeadRoom;
<span class="fc" id="L17">    private long lastTouchedPage = 0,</span>
            lastTouchedPos = 0,
            lastPos = 0;
<span class="fc" id="L20">    private int lastBytesHashcode = -1;</span>
<span class="fc" id="L21">    private long averageMove = 0;</span>

    public PretoucherState(@NotNull LongSupplier posSupplier) {
<span class="fc" id="L24">        this(posSupplier, HEAD_ROOM);</span>
<span class="fc" id="L25">    }</span>

<span class="fc" id="L27">    public PretoucherState(@NotNull LongSupplier posSupplier, int minHeadRoom) {</span>
<span class="fc" id="L28">        this.posSupplier = posSupplier;</span>
<span class="fc" id="L29">        this.minHeadRoom = minHeadRoom;</span>
<span class="fc" id="L30">    }</span>

    static File getFile(MappedBytes bytes) {
<span class="fc bfc" id="L33" title="All 2 branches covered.">        if (bytes == null)</span>
<span class="fc" id="L34">            return new File(&quot;none&quot;);</span>

<span class="fc" id="L36">        return bytes.mappedFile().file();</span>
    }

    // cannot make this @NotNull until PretoucherStateTest is fixed to not pass null
    public void pretouch(MappedBytes bytes) {
        final long pos;
        try {
<span class="fc" id="L43">            pos = posSupplier.getAsLong();</span>
<span class="nc" id="L44">        } catch (NullPointerException npe) {</span>
<span class="nc" id="L45">            throw new IllegalStateException(&quot;Encountered an NPE, possibly because the store was released by something else&quot;, npe);</span>
<span class="fc" id="L46">        }</span>
        // don't retain the bytes object when it is head so keep the hashCode instead.
        // small risk of a duplicate hashCode.
<span class="fc" id="L49">        int pageSize = OS.pageSize();</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">        if (lastBytesHashcode != System.identityHashCode(bytes)) {</span>
<span class="fc" id="L51">            lastTouchedPage = pos - pos % pageSize;</span>
<span class="fc" id="L52">            lastTouchedPos = pos;</span>
<span class="fc" id="L53">            lastBytesHashcode = System.identityHashCode(bytes);</span>
<span class="fc" id="L54">            averageMove = OS.pageSize();</span>
<span class="fc" id="L55">            lastPos = pos;</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">            if (Jvm.isDebugEnabled(getClass())) {</span>
<span class="fc" id="L57">                String message = getFile(bytes) + &quot; - Reset pretoucher to pos &quot; + pos + &quot; as the underlying MappedBytes changed.&quot;;</span>
<span class="fc" id="L58">                debug(message);</span>
<span class="fc" id="L59">            }</span>
        } else {
<span class="fc" id="L61">            long moved = pos - lastPos;</span>
<span class="fc" id="L62">            averageMove = moved / FACTOR + averageMove * (FACTOR - 1) / FACTOR;</span>
<span class="fc" id="L63">            long neededHeadRoom = Math.max(minHeadRoom, averageMove * FACTOR); // for the next $FACTOR ticks.</span>
<span class="fc" id="L64">            final long neededEnd = pos + neededHeadRoom;</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">            if (lastTouchedPage &lt; neededEnd) {</span>
<span class="fc" id="L66">                Thread thread = Thread.currentThread();</span>
<span class="fc" id="L67">                int count = 0, pretouch = 0;</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">                for (; lastTouchedPage &lt; neededEnd; lastTouchedPage += pageSize) {</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">                    if (thread.isInterrupted())</span>
<span class="nc" id="L70">                        break;</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">                    if (touchPage(bytes, lastTouchedPage))</span>
<span class="fc" id="L72">                        pretouch++;</span>
<span class="fc" id="L73">                    count++;</span>
                }
<span class="fc" id="L75">                onTouched(count);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">                if (pretouch &lt; count) {</span>
<span class="fc" id="L77">                    minHeadRoom += 256 &lt;&lt; 10;</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">                    if (Jvm.isDebugEnabled(getClass()))</span>
<span class="fc" id="L79">                        debug(&quot;pretouch for only &quot; + pretouch + &quot; of &quot; + count + &quot; min: &quot; + (minHeadRoom &gt;&gt; 20) + &quot; MB.&quot;);</span>
                }

<span class="fc" id="L82">                long pos2 = posSupplier.getAsLong();</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">                if (Jvm.isDebugEnabled(getClass())) {</span>
<span class="fc" id="L84">                    String message = getFile(bytes) + &quot;: Advanced &quot; + (pos - lastTouchedPos) / 1024 + &quot; KB, &quot; +</span>
                            &quot;avg &quot; + averageMove / 1024 + &quot; KB &quot; +
                            &quot;between pretouch() and &quot; + (pos2 - pos) / 1024 + &quot; KB &quot; +
                            &quot;while mapping of &quot; + pretouch * pageSize / 1024 + &quot; KB &quot;;
<span class="fc" id="L88">                    debug(message);</span>
                }
<span class="fc" id="L90">                lastTouchedPos = pos;</span>
            }
<span class="fc" id="L92">            lastPos = pos;</span>
        }
<span class="fc" id="L94">    }</span>

    protected void debug(String message) {
<span class="fc" id="L97">        Jvm.debug().on(getClass(), message);</span>
<span class="fc" id="L98">    }</span>

    protected boolean touchPage(MappedBytes bytes, long offset) {
<span class="pc bpc" id="L101" title="1 of 4 branches missed.">        return bytes != null &amp;&amp; bytes.compareAndSwapLong(offset, 0L, 0L);</span>
    }

    protected void onTouched(int count) {
<span class="fc" id="L105">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>