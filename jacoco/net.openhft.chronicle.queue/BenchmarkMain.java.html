<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BenchmarkMain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenHFT/Chronicle-Queue</a> &gt; <a href="index.source.html" class="el_package">net.openhft.chronicle.queue</a> &gt; <span class="el_source">BenchmarkMain.java</span></div><h1>BenchmarkMain.java</h1><pre class="source lang-java linenums">package net.openhft.chronicle.queue;

import net.openhft.chronicle.bytes.Bytes;
import net.openhft.chronicle.bytes.MappedFile;
import net.openhft.chronicle.core.Jvm;
import net.openhft.chronicle.core.Memory;
import net.openhft.chronicle.core.OS;
import net.openhft.chronicle.core.io.IOTools;
import net.openhft.chronicle.core.util.Histogram;
import net.openhft.chronicle.threads.Pauser;
import net.openhft.chronicle.wire.DocumentContext;
import net.openhft.chronicle.wire.Wire;
import org.jetbrains.annotations.NotNull;

import java.util.concurrent.locks.LockSupport;

@Deprecated /* For removal in x.22, use net.openhft.chronicle.queue.main.BenchmarkMain instead */
<span class="nc" id="L18">public class BenchmarkMain {</span>
<span class="nc" id="L19">    static volatile boolean running = true;</span>
<span class="nc" id="L20">    static int throughput = Integer.getInteger(&quot;throughput&quot;, 250); // MB/s</span>
<span class="nc" id="L21">    static int runtime = Integer.getInteger(&quot;runtime&quot;, 300); // seconds</span>
<span class="nc" id="L22">    static String basePath = System.getProperty(&quot;path&quot;, OS.TMP);</span>
<span class="nc" id="L23">    static volatile long readerLoopTime = 0;</span>
<span class="nc" id="L24">    static volatile long readerEndLoopTime = 0;</span>
<span class="nc" id="L25">    static int counter = 0;</span>

    static {
<span class="nc" id="L28">        System.setProperty(&quot;jvm.safepoint.enabled&quot;, &quot;true&quot;);</span>
<span class="nc" id="L29">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L32">        System.out.println(</span>
                &quot;-Dthroughput=&quot; + throughput
                        + &quot; -Druntime=&quot; + runtime
                        + &quot; -Dpath=&quot; + basePath);
<span class="nc" id="L36">        MappedFile.warmup();</span>
<span class="nc" id="L37">        System.out.println(&quot;Warming up&quot;);</span>
<span class="nc" id="L38">        benchmark(128);</span>
<span class="nc" id="L39">        System.out.println(&quot;Warmed up&quot;);</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        for (int size = 64; size &lt;= 16 &lt;&lt; 20; size *= 4) {</span>
<span class="nc" id="L41">            benchmark(size);</span>
        }
<span class="nc" id="L43">    }</span>

    static void benchmark(int messageSize) {
<span class="nc" id="L46">        Histogram writeTime = new Histogram(32, 7);</span>
<span class="nc" id="L47">        Histogram transportTime = new Histogram(32, 7);</span>
<span class="nc" id="L48">        Histogram readTime = new Histogram(32, 7);</span>
<span class="nc" id="L49">        String path = basePath + &quot;/test-q-&quot; + messageSize;</span>

<span class="nc" id="L51">        ChronicleQueue queue = createQueue(path);</span>

<span class="nc" id="L53">        Thread pretoucher = new Thread(() -&gt; {</span>
<span class="nc" id="L54">            ExcerptAppender appender = queue.acquireAppender();</span>
<span class="nc" id="L55">            Thread thread = Thread.currentThread();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">            while (!thread.isInterrupted()) {</span>
<span class="nc" id="L57">                appender.pretouch();</span>
<span class="nc" id="L58">                Jvm.pause(10);</span>
            }
<span class="nc" id="L60">        });</span>
<span class="nc" id="L61">        pretoucher.setDaemon(true);</span>
<span class="nc" id="L62">        pretoucher.start();</span>

<span class="nc" id="L64">        Histogram loopTime = new Histogram();</span>

<span class="nc" id="L66">        Thread reader = new Thread(() -&gt; {</span>
//            try (ChronicleQueue queue2 = createQueue(path))
<span class="nc" id="L68">            ExcerptTailer tailer = queue.createTailer().toEnd();</span>
<span class="nc" id="L69">            long endLoop = System.nanoTime();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            while (running) {</span>
<span class="nc" id="L71">                loopTime.sample((double) (System.nanoTime() - endLoop));</span>
<span class="nc" id="L72">                Jvm.safepoint();</span>

//                    readerLoopTime = System.nanoTime();
//                    if (readerLoopTime - readerEndLoopTime &gt; 1000)
//                        System.out.println(&quot;r &quot; + (readerLoopTime - readerEndLoopTime));
//                try {
<span class="nc" id="L78">                runInner(transportTime, readTime, tailer);</span>
<span class="nc" id="L79">                runInner(transportTime, readTime, tailer);</span>
<span class="nc" id="L80">                runInner(transportTime, readTime, tailer);</span>
<span class="nc" id="L81">                runInner(transportTime, readTime, tailer);</span>
//                } finally {
//                        readerEndLoopTime = System.nanoTime();
//                }
<span class="nc" id="L85">                Jvm.safepoint();</span>
<span class="nc" id="L86">                endLoop = System.nanoTime();</span>
            }
<span class="nc" id="L88">        });</span>
<span class="nc" id="L89">        reader.start();</span>
<span class="nc" id="L90">        Jvm.pause(250); // give the reader time to start</span>
<span class="nc" id="L91">        long next = System.nanoTime();</span>
<span class="nc" id="L92">        long end = (long) (next + runtime * 1e9);</span>

<span class="nc" id="L94">        ExcerptAppender appender = queue.acquireAppender();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        while (end &gt; System.nanoTime()) {</span>
<span class="nc" id="L96">            long start = System.nanoTime();</span>
<span class="nc" id="L97">            try (DocumentContext dc = appender.writingDocument(false)) {</span>
<span class="nc" id="L98">                writeMessage(dc.wire(), messageSize);</span>
            }
<span class="nc" id="L100">            long written = System.nanoTime();</span>
<span class="nc" id="L101">            long time = written - start;</span>
//                System.out.println(time);
<span class="nc" id="L103">            writeTime.sample(time);</span>

<span class="nc" id="L105">            long diff = writeTime.totalCount() - readTime.totalCount();</span>
<span class="nc" id="L106">            Thread.yield();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (diff &gt;= 200) {</span>
//                long rlt = readerLoopTime;
//                long delay = System.nanoTime() - rlt;
<span class="nc" id="L110">                System.out.println(&quot;diff=&quot; + diff /* +&quot; delay= &quot; + delay*/);</span>
<span class="nc" id="L111">                StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L112">                sb.append(&quot;Reader: profile of the thread&quot;);</span>
<span class="nc" id="L113">                Jvm.trimStackTrace(sb, reader.getStackTrace());</span>
<span class="nc" id="L114">                System.out.println(sb);</span>
            }

<span class="nc" id="L117">            next += messageSize * 1e9 / (throughput * 1e6);</span>
<span class="nc" id="L118">            long delay = next - System.nanoTime();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (delay &gt; 0)</span>
<span class="nc" id="L120">                LockSupport.parkNanos(delay);</span>
<span class="nc" id="L121">        }</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">        while (readTime.totalCount() &lt; writeTime.totalCount())</span>
<span class="nc" id="L124">            Jvm.pause(50);</span>

<span class="nc" id="L126">        pretoucher.interrupt();</span>
<span class="nc" id="L127">        reader.interrupt();</span>
<span class="nc" id="L128">        running = false;</span>
//        monitor.interrupt();

<span class="nc" id="L131">        System.out.println(&quot;Loop times &quot; + loopTime.toMicrosFormat());</span>
<span class="nc" id="L132">        System.out.println(&quot;messageSize &quot; + messageSize);</span>
<span class="nc" id="L133">        System.out.println(&quot;messages &quot; + writeTime.totalCount());</span>
<span class="nc" id="L134">        System.out.println(&quot;write histogram: &quot; + writeTime.toMicrosFormat());</span>
<span class="nc" id="L135">        System.out.println(&quot;transport histogram: &quot; + transportTime.toMicrosFormat());</span>
<span class="nc" id="L136">        System.out.println(&quot;read histogram: &quot; + readTime.toMicrosFormat());</span>
<span class="nc" id="L137">        IOTools.deleteDirWithFiles(path, 2);</span>
<span class="nc" id="L138">        Jvm.pause(1000);</span>
<span class="nc" id="L139">    }</span>

    private static void runInner(Histogram transportTime, Histogram readTime, ExcerptTailer tailer) {
<span class="nc" id="L142">        Jvm.safepoint();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (tailer.peekDocument()) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (counter++ &lt; 1000) {</span>
<span class="nc" id="L145">                Jvm.safepoint();</span>
<span class="nc" id="L146">                return;</span>
            }
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (counter &gt; 0)</span>
<span class="nc" id="L150">            Jvm.safepoint();</span>
        else
<span class="nc" id="L152">            Jvm.safepoint();</span>
<span class="nc" id="L153">        counter = 0;</span>
<span class="nc" id="L154">        try (DocumentContext dc = tailer.readingDocument(false)) {</span>
<span class="nc" id="L155">            Jvm.safepoint();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (!dc.isPresent()) {</span>
<span class="nc" id="L157">                return;</span>
            }
<span class="nc" id="L159">            long transport = System.nanoTime();</span>
<span class="nc" id="L160">            Jvm.safepoint();</span>
<span class="nc" id="L161">            Wire wire = dc.wire();</span>
<span class="nc" id="L162">            Bytes&lt;?&gt; bytes = wire.bytes();</span>
<span class="nc" id="L163">            long start = readMessage(bytes);</span>
<span class="nc" id="L164">            long end = System.nanoTime();</span>
<span class="nc" id="L165">            transportTime.sample((double) (transport - start));</span>
<span class="nc" id="L166">            readTime.sample((double) (end - transport));</span>
        }
<span class="nc" id="L168">        Jvm.safepoint();</span>
<span class="nc" id="L169">    }</span>

    @NotNull
    private static ChronicleQueue createQueue(String path) {
<span class="nc" id="L173">        return ChronicleQueue.singleBuilder(path)</span>
<span class="nc" id="L174">                .blockSize(1 &lt;&lt; 30)</span>
<span class="nc" id="L175">                .pauserSupplier(Pauser::timedBusy)</span>
<span class="nc" id="L176">                .build();</span>
    }

    private static long readMessage(Bytes&lt;?&gt; bytes) {
<span class="nc" id="L180">        Jvm.safepoint();</span>
<span class="nc" id="L181">        long start = bytes.readLong();</span>
<span class="nc" id="L182">        long rp = bytes.readPosition();</span>
<span class="nc" id="L183">        long rl = bytes.readLimit();</span>
<span class="nc" id="L184">        long addr = bytes.addressForRead(rp);</span>
<span class="nc" id="L185">        long addrEnd = bytes.addressForRead(rl);</span>
<span class="nc" id="L186">        Memory memory = OS.memory();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        for (addr += 8; addr + 7 &lt; addrEnd; addr += 8)</span>
<span class="nc" id="L188">            memory.readLong(addr);</span>
<span class="nc" id="L189">        Jvm.safepoint();</span>
<span class="nc" id="L190">        return start;</span>
    }

    private static void writeMessage(Wire wire, int messageSize) {
<span class="nc" id="L194">        Bytes&lt;?&gt; bytes = wire.bytes();</span>
<span class="nc" id="L195">        long wp = bytes.writePosition();</span>
<span class="nc" id="L196">        long addr = bytes.addressForWrite(wp);</span>
<span class="nc" id="L197">        Memory memory = OS.memory();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (int i = 0; i &lt; messageSize; i += 16) {</span>
<span class="nc" id="L199">            memory.writeLong(addr + i, 0L);</span>
<span class="nc" id="L200">            memory.writeLong(addr + i + 8, 0L);</span>
        }

<span class="nc" id="L203">        bytes.writeSkip(messageSize);</span>
<span class="nc" id="L204">        bytes.writeLong(wp, System.nanoTime());</span>
<span class="nc" id="L205">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>